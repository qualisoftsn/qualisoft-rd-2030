// ==========================================
// CONFIGURATION & DATASOURCE
// ==========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// CŒUR DU SYSTÈME & MULTI-TENANCY
// ==========================================

model Tenant {
  T_Id                  String             @id @default(uuid())
  T_Name                String
  T_Email               String             @unique
  T_Domain              String             @unique
  T_Plan                Plan               @default(ESSAI)
  T_SubscriptionStatus  SubscriptionStatus @default(TRIAL)
  T_SubscriptionEndDate DateTime?
  T_IsActive            Boolean            @default(true)
  T_CreatedAt           DateTime           @default(now())
  T_UpdatedAt           DateTime           @updatedAt
  T_Address             String?
  T_Phone               String?
  T_CeoName             String?
  T_ContractDuration    Int                @default(24)
  T_TacitRenewal        Boolean            @default(true)

  // Relations
  T_Users               User[]
  T_Sites               Site[]
  T_OrgUnits            OrgUnit[]
  T_Processes           Processus[]
  T_PAQs                PAQ[]
  T_Documents           Document[]
  T_Risks               Risk[]
  T_Audits              Audit[]
  T_NonConformites      NonConformite[]
  T_Reclamations        Reclamation[]
  T_Actions             Action[]
  T_SSEEvents           SSEEvent[]
  T_Causeries           Causerie[]
  T_Meetings            Meeting[]
  T_Indicators          Indicator[]
  T_RevueDirections     RevueDirection[]
  T_ProcessReviews      ProcessReview[]
  T_Signatures          Signature[]
  T_AuditLogs           SecurityAuditLog[]
  T_Transactions        Transaction[]
  T_SSEStats            SSEStats[]
  T_Preuves             Preuve[]
  T_Equipments          Equipment[]
  T_Competences         Competence[]
  T_Tiers               Tier[]
  T_Formations          Formation[]
  T_Tickets             Ticket[]
  T_Governance          GovernanceActivity[]
  T_OrgUnitTypes        OrgUnitType[]
  T_ProcessTypes        ProcessType[]
  T_RiskTypes           RiskType[]
  T_Consumptions        Consumption[]
  T_Wastes              Waste[]
  T_Notifications       Notification[]
  T_UserHabilitations   userHabilitation[]
  T_QualityObjectives   QualityObjective[]
  T_OrgContexts         OrganizationContext[]
  T_InterestedParties   InterestedParty[]
  T_ApprovalWorkflows   ApprovalWorkflow[]
  T_ChangeLogs          ChangeLog[]
}

// ==========================================
// STRUCTURE ORGANISATIONNELLE
// ==========================================

model Site {
  S_Id       String  @id @default(uuid())
  S_Name     String
  S_Address  String?
  S_City     String?
  S_Country  String? @default("Sénégal")
  S_IsActive Boolean @default(true)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  S_OrgUnits   OrgUnit[]
  S_Users      User[]
  S_Audits     Audit[]
  S_Documents  Document[]
  S_SSEEvents  SSEEvent[]
  S_Consumptions Consumption[]
  S_Wastes     Waste[]
  S_CreatedAt  DateTime @default(now())
  S_UpdatedAt  DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, S_IsActive])
}

model OrgUnitType {
  OUT_Id          String  @id @default(uuid())
  OUT_Label       String
  OUT_Description String?
  OUT_IsActive    Boolean @default(true)
  OUT_CreatedAt   DateTime @default(now())

  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  OUT_Units OrgUnit[]

  @@unique([OUT_Label, tenantId])
  @@index([tenantId])
}

model OrgUnit {
  OU_Id     String      @id @default(uuid())
  OU_Name   String
  OU_Code   String?
  OU_TypeId String
  OU_Type   OrgUnitType @relation(fields: [OU_TypeId], references: [OUT_Id])

  OU_ParentId String?
  OU_Parent   OrgUnit?  @relation("OrgHierarchy", fields: [OU_ParentId], references: [OU_Id])
  OU_Children OrgUnit[] @relation("OrgHierarchy")

  OU_SiteId String
  OU_Site   Site   @relation(fields: [OU_SiteId], references: [S_Id], onDelete: Cascade)

  tenantId    String
  tenant      Tenant  @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  OU_IsActive Boolean @default(true)
  OU_Users    User[]
  OU_CreatedAt DateTime @default(now())
  OU_UpdatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, OU_SiteId])
}

model User {
  U_Id           String   @id @default(uuid())
  U_Email        String   @unique
  U_PasswordHash String
  U_FirstName    String?
  U_LastName     String?
  U_Phone        String?
  U_Role         Role     @default(USER)
  U_IsActive     Boolean  @default(true)
  U_CreatedAt    DateTime @default(now())
  U_UpdatedAt    DateTime @updatedAt
  U_FirstLogin   Boolean  @default(true)
  U_LastLoginAt  DateTime?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  U_SiteId    String?
  U_Site      Site?    @relation(fields: [U_SiteId], references: [S_Id])
  U_OrgUnitId String?
  U_OrgUnit   OrgUnit? @relation(fields: [U_OrgUnitId], references: [OU_Id])

  U_PiloteProcesses     Processus[]           @relation("PiloteProcessus")
  U_CoPiloteProcesses   Processus[]           @relation("CoPiloteProcessus")
  U_PAQsManaged         PAQ[]                 @relation("QualityManagerPAQ")
  U_AuditsLead          Audit[]               @relation("LeadAuditor")
  U_ResponsibleActions  Action[]              @relation("ResponsibleAction")
  U_CreatedActions      Action[]              @relation("CreatorAction")
  U_DetectedNCs         NonConformite[]       @relation("NCDetector")
  U_ReclamationsOwned   Reclamation[]         @relation("ReclamationOwner")
  U_ReportedEvents      SSEEvent[]            @relation("EventReporter")
  U_VictimInEvents      SSEEvent[]            @relation("EventVictim")
  U_CauseriesAnimate    Causerie[]            @relation("AnimateurCauserie")
  U_CauseriesAttend     Causerie[]            @relation("ParticipantsCauserie")
  U_MeetingAttendees    MeetingAttendee[]
  U_Formations          Formation[]
  U_DocumentVersions    DocumentVersion[]
  U_Signatures          Signature[]
  U_Competences         UserCompetence[]
  U_SecurityAuditLogs   SecurityAuditLog[]
  U_Consumptions        Consumption[]         @relation("ConsumptionCreator")
  U_Notifications       Notification[]
  U_UserHabilitations   userHabilitation[]
  U_QualityObjectives   QualityObjective[]    @relation("ObjectiveOwner")
  U_ApprovalWorkflows   ApprovalWorkflow[]    @relation("WorkflowApprover")
  U_ChangeLogs          ChangeLog[]           @relation("ChangeLogUser")
  U_DocumentsOwned        Document[]  @relation("DocumentOwner")
  U_VersionsApproved      DocumentVersion[] @relation("VersionApprover")
  U_AssignedProcessId String?
  U_AssignedProcess   Processus? @relation("UserAssignedProcess", fields: [U_AssignedProcessId], references: [PR_Id])
  @@index([tenantId])
  @@index([tenantId, U_IsActive])
  @@index([tenantId, U_Role])
}

// ==========================================
// CONTEXTE ORGANISATION (ISO 9001 §4)
// ==========================================

model OrganizationContext {
  OC_Id              String   @id @default(uuid())
  OC_Type            ContextType
  OC_Title           String
  OC_Description     String   @db.Text
  OC_Impact          String?  @db.Text
  OC_ActionsPlanif   String?  @db.Text
  OC_ReviewDate      DateTime?
  OC_IsActive        Boolean  @default(true)
  OC_CreatedAt       DateTime @default(now())
  OC_UpdatedAt       DateTime @updatedAt

  tenantId           String
  tenant             Tenant   @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, OC_Type])
}

model InterestedParty {
  IP_Id              String   @id @default(uuid())
  IP_Name            String
  IP_Type            PartyType
  IP_Needs           String   @db.Text
  IP_Expectations    String   @db.Text
  IP_Requirements    String?  @db.Text
  IP_IsActive        Boolean  @default(true)
  IP_CreatedAt       DateTime @default(now())
  IP_UpdatedAt       DateTime @updatedAt

  tenantId           String
  tenant             Tenant   @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, IP_Type])
}

// ==========================================
// PROCESSUS ET QUALITÉ
// ==========================================

model ProcessType {
  PT_Id          String  @id @default(uuid())
  PT_Label       String
  PT_Description String?
  PT_Color       String? @default("#3b82f6")
  PT_Family       ProcessFamily @default(OPERATIONNEL)
  PT_IsActive    Boolean @default(true)
  PT_CreatedAt   DateTime @default(now())

  tenantId     String
  tenant       Tenant      @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  PT_Processes Processus[]

  @@unique([PT_Label, tenantId])
  @@index([tenantId])
  @@index([PT_Family])
}

model Processus {
  PR_Id          String      @id @default(uuid())
  PR_Code        String
  PR_Libelle     String
  PR_Description String?     @db.Text
  PR_Objectifs   String?     @db.Text
  PR_Ressources  String?     @db.Text
  PR_Surveillance String?    @db.Text
  PR_Version     Int         @default(1)
  PR_DateRevision DateTime?
  PR_TypeId      String
  PR_Type        ProcessType @relation(fields: [PR_TypeId], references: [PT_Id])
  PR_IsActive    Boolean     @default(true)
  PR_DefaultUsers     User[]   @relation("UserAssignedProcess")
  PR_PiloteId   String
  PR_Pilote     User    @relation("PiloteProcessus", fields: [PR_PiloteId], references: [U_Id])
  PR_CoPiloteId String?
  PR_CoPilote   User?   @relation("CoPiloteProcessus", fields: [PR_CoPiloteId], references: [U_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  PR_NonConformites       NonConformite[]
  PR_PAQ                  PAQ[]
  PR_Indicators           Indicator[]
  PR_Risks                Risk[]
  PR_Audits               Audit[]
  PR_Meetings             Meeting[]
  PR_SSEEvents            SSEEvent[]
  PR_Documents            Document[]
  PR_Reclamations         Reclamation[]
  PR_Reviews              ProcessReview[]
  PR_QualityObjectives    QualityObjective[]
  PR_CreatedAt            DateTime             @default(now())
  PR_UpdatedAt            DateTime             @updatedAt
  PR_GovernanceActivities GovernanceActivity[] @relation("ProcessGovernance")

  @@unique([PR_Code, tenantId])
  @@index([tenantId])
  @@index([tenantId, PR_IsActive])
  @@index([tenantId, PR_PiloteId])
}

model QualityObjective {
  QO_Id           String    @id @default(uuid())
  QO_Title        String
  QO_Description  String?   @db.Text
  QO_Target       String
  QO_Deadline     DateTime
  QO_Status       ObjectiveStatus @default(EN_COURS)
  QO_Progress     Float     @default(0)
  QO_IsActive     Boolean   @default(true)
  QO_CreatedAt    DateTime  @default(now())
  QO_UpdatedAt    DateTime  @updatedAt

  QO_ProcessusId  String?
  QO_Processus    Processus? @relation(fields: [QO_ProcessusId], references: [PR_Id])
  QO_OwnerId      String
  QO_Owner        User      @relation("ObjectiveOwner", fields: [QO_OwnerId], references: [U_Id])

  tenantId        String
  tenant          Tenant    @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  QO_Indicators   Indicator[]

  @@index([tenantId])
  @@index([tenantId, QO_Status])
  @@index([tenantId, QO_OwnerId])
}

model PAQ {
  PAQ_Id               String    @id @default(uuid())
  PAQ_Title            String
  PAQ_Description      String?   @db.Text
  PAQ_Year             Int
  PAQ_Status           PAQStatus @default(EN_COURS)
  PAQ_Budget           Float?
  PAQ_DateCloture      DateTime?
  PAQ_IsActive         Boolean   @default(true)
  PAQ_ProcessusId      String
  PAQ_Processus        Processus @relation(fields: [PAQ_ProcessusId], references: [PR_Id], onDelete: Cascade)
  PAQ_QualityManagerId String
  PAQ_QualityManager   User      @relation("QualityManagerPAQ", fields: [PAQ_QualityManagerId], references: [U_Id])

  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  PAQ_Actions   Action[]
  PAQ_CreatedAt DateTime @default(now())
  PAQ_UpdatedAt DateTime @updatedAt

  @@unique([PAQ_ProcessusId, PAQ_Year, tenantId])
  @@index([tenantId])
  @@index([tenantId, PAQ_Status])
}

model Action {
  ACT_Id          String       @id @default(uuid())
  ACT_Title       String
  ACT_Description String?      @db.Text
  ACT_Origin      ActionOrigin @default(AUTRE)
  ACT_Type        ActionType   @default(CORRECTIVE)
  ACT_Status      ActionStatus @default(A_FAIRE)
  ACT_Priority    Priority     @default(MEDIUM)
  ACT_IsActive    Boolean      @default(true)
  ACT_CreatedAt   DateTime     @default(now())
  ACT_Deadline    DateTime?
  ACT_CompletedAt DateTime?
  ACT_UpdatedAt   DateTime     @updatedAt

  ACT_ResponsableId String
  ACT_Responsable   User   @relation("ResponsibleAction", fields: [ACT_ResponsableId], references: [U_Id])
  ACT_CreatorId     String
  ACT_Creator       User   @relation("CreatorAction", fields: [ACT_CreatorId], references: [U_Id])

  ACT_PAQId         String
  ACT_PAQ           PAQ            @relation(fields: [ACT_PAQId], references: [PAQ_Id], onDelete: Cascade)
  ACT_NCId          String?
  ACT_NC            NonConformite? @relation(fields: [ACT_NCId], references: [NC_Id])
  ACT_ReclamationId String?
  ACT_Reclamation   Reclamation?   @relation(fields: [ACT_ReclamationId], references: [REC_Id])
  ACT_AuditId       String?
  ACT_Audit         Audit?         @relation(fields: [ACT_AuditId], references: [AU_Id])
  ACT_MeetingId     String?
  ACT_Meeting       Meeting?       @relation(fields: [ACT_MeetingId], references: [MG_Id])
  ACT_SSEEventId    String?
  ACT_SSEEvent      SSEEvent?      @relation(fields: [ACT_SSEEventId], references: [SSE_Id])

  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  ACT_Preuves Preuve[]

  @@index([tenantId])
  @@index([tenantId, ACT_Status])
  @@index([tenantId, ACT_ResponsableId, ACT_Status])
  @@index([ACT_Deadline, ACT_Status])
  @@index([tenantId, ACT_Priority])
}

// ==========================================
// PERFORMANCE & INDICATEURS
// ==========================================

model Indicator {
  IND_Id        String  @id @default(uuid())
  IND_Code      String
  IND_Libelle   String
  IND_Unite     String
  IND_Cible     Float
  IND_Frequence String  @default("MENSUEL")
  IND_IsActive  Boolean @default(true)
  IND_CreatedAt DateTime @default(now())
  IND_UpdatedAt DateTime @updatedAt

  IND_ProcessusId String
  IND_Processus   Processus @relation(fields: [IND_ProcessusId], references: [PR_Id])

  IND_ObjectiveId String?
  IND_Objective   QualityObjective? @relation(fields: [IND_ObjectiveId], references: [QO_Id])

  tenantId   String
  tenant     Tenant           @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  IND_Values IndicatorValue[]

  @@unique([IND_Code, tenantId])
  @@index([tenantId])
  @@index([tenantId, IND_ProcessusId])
}

model IndicatorValue {
  IV_Id       String   @id @default(uuid())
  IV_Month    Int
  IV_Year     Int
  IV_Actual   Float
  IV_Status   IVStatus @default(BROUILLON)
  IV_Comment  String?  @db.Text
  IV_IsActive Boolean  @default(true)
  IV_CreatedAt DateTime @default(now())
  IV_UpdatedAt DateTime @updatedAt

  IV_IndicatorId String
  IV_Indicator   Indicator @relation(fields: [IV_IndicatorId], references: [IND_Id], onDelete: Cascade)

  @@unique([IV_IndicatorId, IV_Month, IV_Year])
  @@index([IV_Month, IV_Year])
  @@index([IV_IndicatorId, IV_Status])
}

// ==========================================
// AUDITS & QUALITÉ
// ==========================================

model Audit {
  AU_Id          String      @id @default(uuid())
  AU_Reference   String      @unique
  AU_Title       String
  AU_Scope       String      @db.Text
  AU_Type        AuditType   @default(INTERNE)
  AU_NormesRef   String[]
  AU_DateAudit   DateTime
  AU_DateRapport DateTime?
  AU_Status      AuditStatus @default(PLANIFIE)
  AU_Conclusion  String?     @db.Text
  AU_IsActive    Boolean     @default(true)
  AU_CreatedAt   DateTime    @default(now())
  AU_UpdatedAt   DateTime    @updatedAt

  AU_LeadId      String?
  AU_Lead        User?      @relation("LeadAuditor", fields: [AU_LeadId], references: [U_Id])
  AU_SiteId      String
  AU_Site        Site       @relation(fields: [AU_SiteId], references: [S_Id])
  AU_ProcessusId String?
  AU_Processus   Processus? @relation(fields: [AU_ProcessusId], references: [PR_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  AU_Findings       Finding[]
  AU_NonConformites NonConformite[]
  AU_Preuves        Preuve[]
  AU_Actions        Action[]

  @@index([tenantId])
  @@index([tenantId, AU_Status])
  @@index([tenantId, AU_Type])
  @@index([AU_DateAudit])
}

model Finding {
  FI_Id          String      @id @default(uuid())
  FI_Description String      @db.Text
  FI_Type        FindingType
  FI_IsActive    Boolean     @default(true)
  FI_CreatedAt   DateTime    @default(now())
  
  FI_AuditId     String
  FI_Audit       Audit       @relation(fields: [FI_AuditId], references: [AU_Id], onDelete: Cascade)

  @@index([FI_AuditId])
}

model NonConformite {
  NC_Id          String   @id @default(uuid())
  NC_Libelle     String
  NC_Description String   @db.Text
  NC_Diagnostic  String?  @db.Text
  NC_Gravite     NCGravity @default(MINEURE)
  NC_Statut      NCStatus @default(DETECTION)
  NC_Source      NCSource @default(INTERNAL_AUDIT)
  NC_IsActive    Boolean  @default(true)
  NC_CreatedAt   DateTime @default(now())
  NC_UpdatedAt   DateTime @updatedAt

  NC_ProcessusId   String?
  NC_Processus     Processus?   @relation(fields: [NC_ProcessusId], references: [PR_Id])
  NC_ReclamationId String?
  NC_Reclamation   Reclamation? @relation(fields: [NC_ReclamationId], references: [REC_Id])
  NC_AuditId       String?
  NC_Audit         Audit?       @relation(fields: [NC_AuditId], references: [AU_Id])
  NC_DetectorId    String?
  NC_Detector      User?        @relation("NCDetector", fields: [NC_DetectorId], references: [U_Id])

  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  NC_Actions Action[]
  NC_Preuves Preuve[]

  @@index([tenantId])
  @@index([tenantId, NC_Statut])
  @@index([NC_ProcessusId, NC_Statut])
}

// ==========================================
// RISQUES & GED
// ==========================================

model Risk {
  RS_Id          String    @id @default(uuid())
  RS_Libelle     String
  RS_Activite    String?
  RS_Tache       String?
  RS_Causes      String?   @db.Text
  RS_Description String?   @db.Text
  RS_Probabilite Int       @default(1)
  RS_Gravite     Int       @default(1)
  RS_Maitrise    Int       @default(1)
  RS_Score       Int       @default(1)
  RS_Status      RiskStatus @default(IDENTIFIE)
  RS_Mesures     String?   @db.Text
  RS_Acteurs     String?   @db.Text
  RS_NextReview  DateTime?
  RS_IsActive    Boolean   @default(true)
  RS_CreatedAt   DateTime  @default(now())
  RS_UpdatedAt   DateTime  @updatedAt

  RS_TypeId      String
  RS_Type        RiskType  @relation(fields: [RS_TypeId], references: [RT_Id])
  RS_ProcessusId String
  RS_Processus   Processus @relation(fields: [RS_ProcessusId], references: [PR_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, RS_Status])
  @@index([tenantId, RS_ProcessusId])
}

model RiskType {
  RT_Id          String  @id @default(uuid())
  RT_Label       String
  RT_Description String?
  RT_IsActive    Boolean @default(true)
  RT_CreatedAt   DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  RT_Risks Risk[]

  @@unique([RT_Label, tenantId])
  @@index([tenantId])
}

model Document {
  DOC_Id             String      @id @default(uuid())
  DOC_Title          String
  DOC_Description    String?     @db.Text
  DOC_Category       DocCategory @default(AUTRE)
  DOC_Status         DocStatus   @default(BROUILLON)
  DOC_CurrentVersion Int         @default(1)
  DOC_IsArchived     Boolean     @default(false)
  DOC_IsActive       Boolean     @default(true)
  DOC_CreatedAt      DateTime    @default(now())
  DOC_UpdatedAt      DateTime    @updatedAt
  DOC_Reference           String?     @unique  // Ex: PR-001-A
  DOC_NextReviewDate      DateTime?
  DOC_ReviewFrequencyMonths Int       @default(12)
  DOC_OwnerId             String?
  DOC_Owner               User?       @relation("DocumentOwner", fields: [DOC_OwnerId], references: [U_Id])
  DOC_Tags                String[]    @default([])
  DOC_Department          String?
  DOC_ArchivedAt          DateTime?
  DOC_ArchivedById        String?
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  DOC_SiteId      String?
  DOC_Site        Site?      @relation(fields: [DOC_SiteId], references: [S_Id])
  DOC_ProcessusId String?
  DOC_Processus   Processus? @relation(fields: [DOC_ProcessusId], references: [PR_Id])

  DOC_Versions DocumentVersion[]
  DOC_Preuves  Preuve[]

  @@index([tenantId])
  @@index([tenantId, DOC_Status])
  @@index([tenantId, DOC_Category])
}

model DocumentVersion {
  DV_Id            String    @id @default(uuid())
  DV_VersionNumber Int
  DV_FileUrl       String
  DV_FileName      String
  DV_FileSize      Int       @default(0)
  DV_Status        DocStatus @default(BROUILLON)
  DV_IsActive      Boolean   @default(true)
  DV_CreatedAt     DateTime  @default(now())
  DV_FileType             String?     // pdf, docx, etc.
  DV_ApprovedById         String?
  DV_ApprovedBy           User?       @relation("VersionApprover", fields: [DV_ApprovedById], references: [U_Id])
  DV_ApprovedAt           DateTime?
  DV_ChangeDescription    String?     @default("Création initiale")
  DV_RejectionComment     String?
  DV_DocumentId  String
  DV_Document    Document @relation(fields: [DV_DocumentId], references: [DOC_Id], onDelete: Cascade)
  DV_CreatedById String
  DV_CreatedBy   User     @relation(fields: [DV_CreatedById], references: [U_Id])

  @@index([DV_DocumentId])
}

model Preuve {
  PV_Id          String  @id @default(uuid())
  PV_Commentaire String?
  PV_FileUrl     String
  PV_FileName    String
  PV_IsActive    Boolean @default(true)
  PV_CreatedAt   DateTime @default(now())

  PV_AuditId       String?
  PV_Audit         Audit?         @relation(fields: [PV_AuditId], references: [AU_Id])
  PV_NCId          String?
  PV_NonConformite NonConformite? @relation(fields: [PV_NCId], references: [NC_Id])
  PV_ActionId      String?
  PV_Action        Action?        @relation(fields: [PV_ActionId], references: [ACT_Id])
  PV_DocumentId    String?
  PV_Document      Document?      @relation(fields: [PV_DocumentId], references: [DOC_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
}

// ==========================================
// RÉCLAMATIONS & TIERS
// ==========================================

model Reclamation {
  REC_Id              String            @id @default(uuid())
  REC_Reference       String            @unique
  REC_Object          String
  REC_Description     String            @db.Text
  REC_Status          ReclamationStatus @default(NOUVELLE)
  REC_Source          String?
  REC_DateReceipt     DateTime          @default(now())
  REC_DateTransmitted DateTime?
  REC_Deadline        DateTime?
  REC_Gravity         Priority          @default(MEDIUM)
  REC_IsActive        Boolean           @default(true)
  REC_CreatedAt       DateTime          @default(now())
  REC_UpdatedAt       DateTime          @updatedAt

  REC_TierId      String
  REC_Tier        Tier       @relation(fields: [REC_TierId], references: [TR_Id])
  REC_ProcessusId String?
  REC_Processus   Processus? @relation(fields: [REC_ProcessusId], references: [PR_Id])
  REC_OwnerId     String
  REC_Owner       User       @relation("ReclamationOwner", fields: [REC_OwnerId], references: [U_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  REC_Actions        Action[]
  REC_NonConformites NonConformite[]

  @@index([tenantId])
  @@index([tenantId, REC_Status])
  @@index([tenantId, REC_OwnerId])
}

model Tier {
  TR_Id       String   @id @default(uuid())
  TR_Name     String
  TR_Email    String?
  TR_Phone    String?
  TR_Type     TierType @default(CLIENT)
  TR_IsActive Boolean  @default(true)
  TR_CreatedAt DateTime @default(now())
  TR_UpdatedAt DateTime @updatedAt

  tenantId        String
  tenant          Tenant        @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  TR_Reclamations Reclamation[]

  @@unique([TR_Id, tenantId])
  @@index([tenantId])
  @@index([tenantId, TR_Type])
}

// ==========================================
// SSE & CAUSERIES (SÉCURITÉ)
// ==========================================

model SSEEvent {
  SSE_Id           String   @id @default(uuid())
  SSE_Type         SSEType
  SSE_DateEvent    DateTime @default(now())
  SSE_Lieu         String
  SSE_Description  String   @db.Text
  SSE_AvecArret    Boolean  @default(false)
  SSE_NbJoursArret Int      @default(0)
  SSE_IsActive     Boolean  @default(true)
  SSE_CreatedAt    DateTime @default(now())
  SSE_UpdatedAt    DateTime @updatedAt

  SSE_ReporterId  String?
  SSE_Reporter    User?      @relation("EventReporter", fields: [SSE_ReporterId], references: [U_Id])
  SSE_VictimId    String?
  SSE_Victim      User?      @relation("EventVictim", fields: [SSE_VictimId], references: [U_Id])
  SSE_SiteId      String
  SSE_Site        Site       @relation(fields: [SSE_SiteId], references: [S_Id])
  SSE_ProcessusId String?
  SSE_Processus   Processus? @relation(fields: [SSE_ProcessusId], references: [PR_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  SSE_Actions Action[]

  @@index([tenantId])
  @@index([tenantId, SSE_Type])
  @@index([SSE_DateEvent])
}

model Causerie {
  CS_Id          String   @id @default(uuid())
  CS_Theme       String
  CS_Date        DateTime @default(now())
  CS_CompteRendu String?  @db.Text
  CS_IsActive    Boolean  @default(true)
  CS_CreatedAt   DateTime @default(now())
  CS_UpdatedAt   DateTime @updatedAt

  CS_AnimateurId  String
  CS_Animateur    User   @relation("AnimateurCauserie", fields: [CS_AnimateurId], references: [U_Id])
  CS_Participants User[] @relation("ParticipantsCauserie")

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([CS_Date])
}

model SSEStats {
  ST_Id            String  @id @default(uuid())
  ST_Mois          Int
  ST_Annee         Int
  ST_NbAccidents   Int
  ST_TauxFrequence Float   @default(0)
  ST_TauxGravite   Float   @default(0)
  ST_IsActive      Boolean @default(true)
  ST_CreatedAt     DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@unique([tenantId, ST_Mois, ST_Annee])
  @@index([tenantId])
  @@index([ST_Mois, ST_Annee])
}

// ==========================================
// ENVIRONNEMENT (ISO 14001)
// ==========================================

model Consumption {
  CON_Id        String   @id @default(uuid())
  CON_Type      String
  CON_Value     Float
  CON_Unit      String
  CON_Month     Int
  CON_Year      Int
  CON_Cost      Float?
  CON_IsActive  Boolean  @default(true)
  CON_CreatedAt DateTime @default(now())
  CON_UpdatedAt DateTime @updatedAt

  CON_SiteId String
  CON_Site   Site   @relation(fields: [CON_SiteId], references: [S_Id])

  CON_CreatorId String?
  CON_Creator   User?   @relation("ConsumptionCreator", fields: [CON_CreatorId], references: [U_Id], onDelete: SetNull)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([CON_Month, CON_Year])
  @@index([tenantId, CON_SiteId])
}

model Waste {
  WAS_Id        String   @id @default(uuid())
  WAS_Label     String
  WAS_Weight    Float
  WAS_Type      String
  WAS_Treatment String
  WAS_Month     Int
  WAS_Year      Int
  WAS_IsActive  Boolean  @default(true)
  WAS_CreatedAt DateTime @default(now())
  WAS_UpdatedAt DateTime @updatedAt

  WAS_SiteId String
  WAS_Site   Site   @relation(fields: [WAS_SiteId], references: [S_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([WAS_Month, WAS_Year])
  @@index([tenantId, WAS_SiteId])
}

// ==========================================
// GOUVERNANCE, RH & MAINTENANCE
// ==========================================

model GovernanceActivity {
  GA_Id             String         @id @default(uuid())
  GA_Num            String?
  GA_Title          String
  GA_Type           GovernanceType
  GA_Theme          String?        @db.Text
  GA_DatePlanned    DateTime
  GA_Deadline       DateTime?
  GA_AnalysisPeriod String?
  GA_IpDate         DateTime?
  GA_EffectiveDate  DateTime?
  GA_Location       String?        @default("Teams")
  GA_Status         ActivityStatus @default(PLANNED)
  GA_Comments       String?        @db.Text
  GA_Observations   String?        @db.Text
  GA_IsActive       Boolean        @default(true)
  GA_CreatedAt      DateTime       @default(now())
  GA_UpdatedAt      DateTime       @updatedAt

  tenantId     String
  tenant       Tenant      @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  GA_Processes Processus[] @relation("ProcessGovernance")

  @@index([tenantId])
  @@index([tenantId, GA_Status])
  @@index([GA_DatePlanned])
}

model Meeting {
  MG_Id       String        @id @default(uuid())
  MG_Title    String
  MG_Date     DateTime
  MG_Status   MeetingStatus @default(PLANIFIE)
  MG_Report   String?       @db.Text
  MG_IsActive Boolean       @default(true)
  MG_CreatedAt DateTime     @default(now())
  MG_UpdatedAt DateTime     @updatedAt

  MG_ProcessId String?
  MG_Processus Processus? @relation(fields: [MG_ProcessId], references: [PR_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  MG_Attendees MeetingAttendee[]
  MG_Actions   Action[]

  @@index([tenantId])
  @@index([tenantId, MG_Status])
  @@index([MG_Date])
}

model MeetingAttendee {
  MA_Id        String  @id @default(uuid())
  MA_MeetingId String
  MA_UserId    String
  MA_Present   Boolean @default(false)
  MA_IsActive  Boolean @default(true)
  MA_Meeting   Meeting @relation(fields: [MA_MeetingId], references: [MG_Id], onDelete: Cascade)
  MA_User      User    @relation(fields: [MA_UserId], references: [U_Id], onDelete: Cascade)

  @@unique([MA_MeetingId, MA_UserId])
}

model Equipment {
  EQ_Id           String   @id @default(uuid())
  EQ_Reference    String   @unique
  EQ_Name         String
  EQ_DateService  DateTime
  EQ_ProchaineVGP DateTime
  EQ_Status       String   @default("OPERATIONNEL")
  EQ_IsActive     Boolean  @default(true)
  EQ_CreatedAt    DateTime @default(now())
  EQ_UpdatedAt    DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, EQ_Status])
}

model Competence {
  CP_Id           String  @id @default(uuid())
  CP_Name         String
  CP_NiveauRequis Int
  CP_IsActive     Boolean @default(true)
  CP_CreatedAt    DateTime @default(now())
  CP_UpdatedAt    DateTime @updatedAt

  tenantId String
  tenant   Tenant           @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)
  CP_Users UserCompetence[]

  @@index([tenantId])
}

model UserCompetence {
  UC_UserId       String
  UC_CompetenceId String
  UC_NiveauActuel Int
  UC_IsActive     Boolean    @default(true)
  UC_CreatedAt    DateTime   @default(now())
  UC_UpdatedAt    DateTime   @updatedAt
  UC_User         User       @relation(fields: [UC_UserId], references: [U_Id], onDelete: Cascade)
  UC_Competence   Competence @relation(fields: [UC_CompetenceId], references: [CP_Id], onDelete: Cascade)

  @@id([UC_UserId, UC_CompetenceId])
}

model Formation {
  FOR_Id       String    @id @default(uuid())
  FOR_Title    String
  FOR_Date     DateTime
  FOR_Expiry   DateTime?
  FOR_Status   String
  FOR_IsActive Boolean   @default(true)
  FOR_CreatedAt DateTime @default(now())
  FOR_UpdatedAt DateTime @updatedAt
  FOR_UserId   String
  FOR_User     User      @relation(fields: [FOR_UserId], references: [U_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id])

  @@index([tenantId])
  @@index([tenantId, FOR_UserId])
}

model ProcessReview {
  PRV_Id                  String       @id @default(uuid())
  PRV_Month               Int
  PRV_Year                Int
  PRV_Status              ReviewStatus @default(BROUILLON)
  PRV_AuditAnalysis       String?      @db.Text
  PRV_PerformanceAnalysis String?      @db.Text
  PRV_ResourcesAnalysis   String?      @db.Text
  PRV_Decisions           String?      @db.Text
  PRV_RiskAnalysis        String?      @db.Text
  PRV_DocRef              String?      @default("F-QLT-011")
  PRV_PiloteSigned        Boolean      @default(false)
  PRV_RQSigned            Boolean      @default(false)
  PRV_IsActive            Boolean      @default(true)
  PRV_CreatedAt           DateTime     @default(now())
  PRV_UpdatedAt           DateTime     @updatedAt

  PRV_ProcessusId String
  PRV_Processus   Processus @relation(fields: [PRV_ProcessusId], references: [PR_Id], onDelete: Cascade)

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@unique([PRV_ProcessusId, PRV_Month, PRV_Year, tenantId])
  @@index([tenantId])
  @@index([tenantId, PRV_Status])
}

model RevueDirection {
  RD_Id       String   @id @default(uuid())
  RD_Periode  String
  RD_Date     DateTime
  RD_IsActive Boolean  @default(true)
  RD_CreatedAt DateTime @default(now())
  RD_UpdatedAt DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([RD_Date])
}

// ==========================================
// NOTIFICATIONS ET RH
// ==========================================

model Notification {
  N_Id        String           @id @default(uuid())
  N_Title     String
  N_Message   String           @db.Text
  N_Type      NotificationType @default(INFO)
  N_IsRead    Boolean          @default(false)
  N_IsActive  Boolean          @default(true)
  N_CreatedAt DateTime         @default(now())

  userId   String
  user     User   @relation(fields: [userId], references: [U_Id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([userId, N_IsRead])
}

model userHabilitation {
  UH_Id           String    @id @default(uuid())
  UH_Label        String
  UH_DateObtained DateTime
  UH_ExpiryDate   DateTime?
  UH_Status       HabStatus @default(ACTIVE)
  UH_IsActive     Boolean   @default(true)
  UH_FileUrl      String?
  UH_CreatedAt    DateTime  @default(now())
  UH_UpdatedAt    DateTime  @updatedAt

  userId   String
  user     User   @relation(fields: [userId], references: [U_Id], onDelete: Cascade)
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([userId])
  @@index([tenantId])
  @@index([tenantId, UH_Status])
}

// ==========================================
// WORKFLOW & TRAÇABILITÉ
// ==========================================

model ApprovalWorkflow {
  AW_Id          String   @id @default(uuid())
  AW_EntityType  String
  AW_EntityId    String
  AW_Step        Int
  AW_Status      WorkflowStatus @default(EN_ATTENTE)
  AW_ApproverId  String
  AW_Approver    User     @relation("WorkflowApprover", fields: [AW_ApproverId], references: [U_Id])
  AW_Comment     String?  @db.Text
  AW_ApprovedAt  DateTime?
  AW_CreatedAt   DateTime @default(now())
  AW_UpdatedAt   DateTime @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId, AW_EntityType, AW_EntityId])
  @@index([tenantId, AW_Status])
  @@index([AW_ApproverId, AW_Status])
}

model ChangeLog {
  CL_Id          String   @id @default(uuid())
  CL_EntityType  String
  CL_EntityId    String
  CL_Action      ChangeAction
  CL_OldValue    Json?
  CL_NewValue    Json?
  CL_UserId      String
  CL_User        User     @relation("ChangeLogUser", fields: [CL_UserId], references: [U_Id])
  CL_Timestamp   DateTime @default(now())

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId, CL_EntityType, CL_EntityId])
  @@index([tenantId, CL_Timestamp])
  @@index([CL_UserId])
}

// ==========================================
// SÉCURITÉ & SUPPORT TECHNIQUE
// ==========================================

model Signature {
  SIG_Id         String  @id @default(uuid())
  SIG_EntityType String
  SIG_EntityId   String
  SIG_Hash       String
  SIG_Metadata   Json?
  SIG_UserId     String
  SIG_IsActive   Boolean @default(true)
  SIG_CreatedAt  DateTime @default(now())
  SIG_User       User    @relation(fields: [SIG_UserId], references: [U_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([SIG_EntityType, SIG_EntityId])
}

model SecurityAuditLog {
  SAL_Id        String   @id @default(uuid())
  SAL_Action    String
  SAL_IpAddress String?
  SAL_UserAgent String?
  SAL_Timestamp DateTime @default(now())
  SAL_UserId    String
  SAL_IsActive  Boolean  @default(true)
  SAL_User      User     @relation(fields: [SAL_UserId], references: [U_Id])

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([SAL_UserId])
  @@index([SAL_Timestamp])
}

model Transaction {
  TX_Id            String            @id @default(uuid())
  TX_Amount        Float
  TX_Currency      String            @default("XOF")
  TX_Reference     String            @unique
  TX_Status        TransactionStatus @default(EN_COURS)
  TX_PaymentMethod PaymentMethod
  TX_ProofUrl      String?
  TX_AdminComment  String?
  TX_IsActive      Boolean           @default(true)
  TX_CreatedAt     DateTime          @default(now())
  TX_UpdatedAt     DateTime          @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id], onDelete: Cascade)

  @@index([tenantId])
  @@index([TX_Status])
}

model Ticket {
  TK_Id          String       @id @default(uuid())
  TK_Subject     String
  TK_Description String       @db.Text
  TK_Status      TicketStatus @default(OPEN)
  TK_Priority    Priority     @default(MEDIUM)
  TK_Response    String?      @db.Text
  TK_ResponseAt  DateTime?
  TK_IsActive    Boolean      @default(true)
  TK_CreatedAt   DateTime     @default(now())
  TK_UpdatedAt   DateTime     @updatedAt

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [T_Id])

  @@index([tenantId])
  @@index([tenantId, TK_Status])
}




// ==========================================
// ÉNUMÉRATIONS
// ==========================================

enum Plan {
  ESSAI
  EMERGENCE
  CROISSANCE
  ENTREPRISE
  GROUPE
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  SUSPENDED
  EXPIRED
  PENDING
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  PILOTE
  COPILOTE
  AUDITEUR
  HSE
  SAFETY_OFFICER
  RQ
  OBSERVATEUR
}

enum ContextType {
  ENJEU_INTERNE
  ENJEU_EXTERNE
  PARTIE_INTERESSEE
  REGLEMENTAIRE
}

enum PartyType {
  CLIENT
  AUTORITE
  ACTIONNAIRE
  EMPLOYE
  FOURNISSEUR
  CONCURRENT
  COLLECTIVITE
  ONG
}

enum ObjectiveStatus {
  BROUILLON
  EN_COURS
  ATTEINT
  NON_ATTEINT
  REPORTE
  ANNULE
}

enum PAQStatus {
  BROUILLON
  EN_COURS
  CLOTURE
  ARCHIVE
}

enum DocStatus {
  BROUILLON
  EN_REVUE
  APPROUVE
  REJETE
  ARCHIVE
  OBSOLETE
}

enum NotificationType {
  INFO
  WARNING
  SUCCESS
  DANGER
  SSE_ALERT
  DEADLINE_ALERT
}

enum HabStatus {
  ACTIVE
  EXPIRED
  REVOKED
  PENDING
}

enum DocCategory {
  PROCEDURE
  MANUEL
  ENREGISTREMENT
  CONSIGNE
  RAPPORT
  FORMULAIRE
  AUTRE
}

enum AuditType {
  INTERNE
  EXTERNE
  CERTIFICATION
  SURVEILLANCE
  TIERCE_PARTIE
}

enum AuditStatus {
  PLANIFIE
  EN_COURS
  TERMINE
  ANNULE
}

enum FindingType {
  POINT_FORT
  CONFORMITE
  OBSERVATION
  NC_MINEURE
  NC_MAJEURE
}

enum NCGravity {
  MINEURE
  MAJEURE
  CRITIQUE
}

enum NCStatus {
  DETECTION
  ANALYSE
  ACTION_EN_COURS
  VERIFICATION
  CLOTURE
}

enum NCSource {
  INTERNAL_AUDIT
  EXTERNAL_AUDIT
  CLIENT_COMPLAINT
  SUPPLIER
  INCIDENT_SAFETY
  PROCESS_REVIEW
  MANAGEMENT_REVIEW
}

enum ActionStatus {
  A_FAIRE
  EN_COURS
  A_VALIDER
  TERMINEE
  NON_EFFICACE
  ANNULEE
  EN_RETARD
}

enum ActionType {
  CORRECTIVE
  PREVENTIVE
  AMELIORATION
}

enum ActionOrigin {
  AUDIT
  NON_CONFORMITE
  RECLAMATION
  REVUE_DIRECTION
  COPIL
  RISQUE
  SSE
  OBJECTIF
  AUTRE
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ARCHIVED
}

enum ReclamationStatus {
  NOUVELLE
  EN_ANALYSE
  ACTION_EN_COURS
  TRAITEE
  REJETEE
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
  CRITICAL
}

enum SSEType {
  ACCIDENT_TRAVAIL
  ACCIDENT_TRAVAIL_TRAJET
  DOMMAGE_MATERIEL
  PRESQU_ACCIDENT
  SITUATION_DANGEREUSE
  MALADIE_PRO
}

enum MeetingStatus {
  PLANIFIE
  EN_COURS
  TERMINE
  ANNULE
}

enum IVStatus {
  BROUILLON
  SOUMIS
  VALIDE
  RENVOYE
}

enum ReviewStatus {
  BROUILLON
  EN_COURS
  VALIDEE
  CLOTUREE
}

enum RiskStatus {
  IDENTIFIE
  EVALUE
  TRAITE
  ACCEPTE
  SURVEILLE
}

enum TierType {
  CLIENT
  FOURNISSEUR
  PARTENAIRE
  ETAT
  SOUS_TRAITANT
}

enum TransactionStatus {
  EN_COURS
  COMPLETE
  ECHOUEE
  A_REFAIRE
}

enum PaymentMethod {
  WAVE
  ORANGE_MONEY
  CREDIT_CARD
  BANK_TRANSFER
  ESSAI
}

enum GovernanceType {
  COPIL
  REVUE_DIRECTION
  REVUE_PROCESSUS
  AUDIT_INTERNE
  AUDIT_EXTERNE
  VEILLE_REGLEMENTAIRE
  SEANCE_PROCESSUS
}

enum ActivityStatus {
  PLANNED
  IN_PROGRESS
  DONE
  POSTPONED
  CANCELLED
}

enum WorkflowStatus {
  EN_ATTENTE
  APPROUVE
  REJETE
  ANNULE
}

enum ChangeAction {
  CREATE
  UPDATE
  DELETE
  RESTORE
}


enum ProcessFamily {
  PILOTAGE      // Management, Stratégie, Amélioration
  OPERATIONNEL  // Cœur de métier, Réalisation, Valeur Client
  SUPPORT       // Ressources, Maintenance, Soutien
}