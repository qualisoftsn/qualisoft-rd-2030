//* eslint-disable @typescript-eslint/no-unused-vars */
"use client";

import { AuthUser, useAuthStore } from "@/store/authStore";
import {
  Activity,
  AlertTriangle,
  Award,
  BookOpen,
  Building,
  Building2,
  CheckSquare,
  ChevronDown,
  ClipboardCheck,
  Contact,
  Crown,
  Database,
  FileSearch,
  FolderOpen,
  Gavel,
  GitBranch,
  GraduationCap,
  HardHat,
  LayoutDashboard,
  LineChart,
  LogOut,
  Map as MapIcon,
  Network,
  Presentation,
  RefreshCw,
  Settings2,
  Target,
  Terminal,
  Truck,
  UserCircle,
  Users,
  Users2,
  Workflow,
} from "lucide-react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import React, { useMemo, useState } from "react";

interface MenuItem {
  title: string;
  path: string;
  icon: React.ElementType;
  access:
    | "ALL"
    | "MANAGER"
    | "ADMIN"
    | "RH"
    | "QSE"
    | "DIRECTION"
    | "SUPERADMIN";
  badge?: number;
}

interface MenuGroup {
  id: string;
  label: string;
  icon: React.ElementType;
  items: MenuItem[];
}

export default function Sidebar({
  user,
  isSuperAdmin,
}: {
  user: AuthUser;
  isSuperAdmin: boolean;
}) {
  const pathname = usePathname();
  const logout = useAuthStore((state) => state.logout);
  const [expandedGroups, setExpandedGroups] = useState<string[]>([
    "ch4_ch5",
    "ch8",
  ]);

  const userRole = useMemo(() => user?.U_Role?.toUpperCase() || "", [user]);

  const roles = useMemo(
    () => ({
      isDirection:
        ["DIRECTEUR", "DG", "PRESIDENT", "RQ"].includes(userRole) ||
        isSuperAdmin,
      isQSE: ["RQ", "QSE", "AUDITEUR"].includes(userRole) || isSuperAdmin,
      isRH: ["RH", "DRH"].includes(userRole) || isSuperAdmin,
      isManager: ["MANAGER", "CHEF"].includes(userRole) || isSuperAdmin,
      isAdmin: ["ADMIN"].includes(userRole) || isSuperAdmin,
    }),
    [userRole, isSuperAdmin],
  );

  const hasAccess = (item: MenuItem): boolean => {
    if (isSuperAdmin) return true;
    switch (item.access) {
      case "ALL":
        return true;
      case "DIRECTION":
        return roles.isDirection;
      case "QSE":
        return roles.isQSE;
      case "RH":
        return roles.isRH;
      case "MANAGER":
        return roles.isManager;
      case "ADMIN":
        return roles.isAdmin;
      case "SUPERADMIN":
        return isSuperAdmin;
      default:
        return false;
    }
  };

  const toggleGroup = (groupId: string) => {
    setExpandedGroups((prev) =>
      prev.includes(groupId)
        ? prev.filter((g) => g !== groupId)
        : [...prev, groupId],
    );
  };

  const menuGroups: MenuGroup[] = useMemo(() => {
    const baseGroups: MenuGroup[] = [
      {
        id: "ch4_ch5",
        label: "Context & Leadership",
        icon: Building,
        items: [
          {
            title: "Cockpit SMI",
            path: "/dashboard",
            icon: LayoutDashboard,
            access: "ALL",
          },
          {
            title: "PAQ & Processus",
            path: "/dashboard/actions",
            icon: Gavel,
            access: "ALL",
          },
          {
            title: "Sites & Unités",
            path: "/dashboard/org-units",
            icon: Network,
            access: "ALL",
          },
          {
            title: "Revues Direction",
            path: "/dashboard/management-review",
            icon: Presentation,
            access: "DIRECTION",
          },
        ],
      },
      {
        id: "ch6",
        label: "Planning (§6)",
        icon: Target,
        items: [
          {
            title: "Objectifs & Kpis",
            path: "/dashboard/objectifs",
            icon: LineChart,
            access: "ALL",
          },
          {
            title: "Gestion des Risques",
            path: "/dashboard/risks",
            icon: Target,
            access: "MANAGER",
          },
          {
            title: "Instances COPIL",
            path: "/dashboard/gouvernance/copil",
            icon: Users2,
            access: "MANAGER",
          },
        ],
      },
      {
        id: "ch7",
        label: "Support (§7)",
        icon: HardHat,
        items: [
          {
            title: "GPEC & Compétences",
            path: "/dashboard/rh",
            icon: Award,
            access: "RH",
          },
          {
            title: "Dossiers RH",
            path: "/dashboard/users",
            icon: UserCircle,
            access: "RH",
          },
          {
            title: "Formations",
            path: "/dashboard/formations",
            icon: GraduationCap,
            access: "RH",
          },
          {
            title: "GED Qualité",
            path: "/dashboard/ged",
            icon: FolderOpen,
            access: "ALL",
          },
          {
            title: "Bibliothèque",
            path: "/dashboard/bibliotheque",
            icon: BookOpen,
            access: "ALL",
          },
          {
            title: "Équipements",
            path: "/dashboard/equipment",
            icon: Building2,
            access: "MANAGER",
          },
        ],
      },
      {
        id: "ch8",
        label: "Opérations (§8)",
        icon: Activity,
        items: [
          {
            title: "Cartographie",
            path: "/dashboard/direction",
            icon: MapIcon,
            access: "ALL",
          },
          {
            title: "Fiches Processus",
            path: "/dashboard/processus",
            icon: GitBranch,
            access: "ALL",
          },
          {
            title: "Tableau de bord Actions",
            path: "/dashboard/actions-tab",
            icon: Workflow,
            access: "MANAGER",
          },
          {
            title: "Workflows",
            path: "/dashboard/workflows",
            icon: Workflow,
            access: "MANAGER",
          },
          {
            title: "Tiers / Achats",
            path: "/dashboard/tiers",
            icon: Truck,
            access: "ALL",
          },
          {
            title: "Réclamations",
            path: "/dashboard/reclamations",
            icon: Contact,
            access: "ALL",
          },
        ],
      },
      {
        id: "ch9_ch10",
        label: "Performance (§9-10)",
        icon: RefreshCw,
        items: [
          {
            title: "Saisie Mesures",
            path: "/dashboard/indicators",
            icon: Activity,
            access: "ALL",
          },
          {
            title: "Audits Internes",
            path: "/dashboard/audits",
            icon: ClipboardCheck,
            access: "QSE",
          },
          {
            title: "Non-Conformités",
            path: "/dashboard/non-conformites",
            icon: AlertTriangle,
            access: "ALL",
            badge: 3,
          },
          {
            title: "PAQ (Actions)",
            path: "/dashboard/improvement",
            icon: CheckSquare,
            access: "ALL",
          },
          {
            title: "Archives",
            path: "/dashboard/archives",
            icon: FileSearch,
            access: "QSE",
          },
        ],
      },
      {
        id: "admin",
        label: "Paramètres",
        icon: Settings2,
        items: [
          {
            title: "Utilisateurs",
            path: "/dashboard/users",
            icon: Users,
            access: "ADMIN",
          },
          {
            title: "Configuration",
            path: "/dashboard/settings",
            icon: Settings2,
            access: "ADMIN",
          },
        ],
      },
    ];

    if (isSuperAdmin) {
      baseGroups.push({
        id: "superadmin",
        label: "Console Souveraine",
        icon: Crown,
        items: [
          {
            title: "Master Console",
            path: "/dashboard/superadmin/console",
            icon: Terminal,
            access: "SUPERADMIN",
          },
          {
            title: "Tenants Matrix",
            path: "/dashboard/superadmin/tenants",
            icon: Database,
            access: "SUPERADMIN",
          },
        ],
      });
    }

    return baseGroups;
  }, [isSuperAdmin]);

  const handleLogout = () => {
    logout();
    localStorage.removeItem("master_access");
    window.location.href = "/auth/login";
  };

  return (
    <aside className="w-72 h-screen bg-[#0F172A] text-white flex flex-col fixed left-0 top-0 z-40 border-r border-white/5 shadow-2xl italic font-sans overflow-hidden">
      {/* BRANDING SECTION */}
      <div className="p-6 shrink-0 border-b border-white/5 bg-[#111A2E]">
        <div className="flex items-center gap-3 mb-4">
          <div
            className={`w-10 h-10 rounded-xl flex items-center justify-center border border-white/10 shadow-lg ${isSuperAdmin ? "bg-amber-500" : "bg-blue-600"}`}
          >
            <span className="font-black text-xl text-white not-italic">
              {isSuperAdmin ? "M" : "Q"}
            </span>
          </div>
          <div>
            <h1 className="text-lg font-black uppercase tracking-tighter leading-none italic">
              Qualisoft
            </h1>
            <p
              className={`text-[8px] font-bold uppercase tracking-[0.3em] mt-1 ${isSuperAdmin ? "text-amber-500" : "text-blue-400"}`}
            >
              {isSuperAdmin ? "SUPER ADMIN" : "SMI EXPERT"}
            </p>
          </div>
        </div>

        <div className="bg-white/5 border border-white/10 rounded-xl p-3 flex items-center gap-2 overflow-hidden">
          <Building2 size={14} className="text-blue-500 shrink-0" />
          <p className="text-[10px] font-black truncate uppercase text-slate-400 tracking-wider italic leading-none">
            {user?.tenantId || "Instance Active"}
          </p>
        </div>
      </div>

      {/* NAVIGATION SCROLLABLE */}
      <nav className="flex-1 overflow-y-auto px-4 py-6 space-y-2 scrollbar-hide">
        {menuGroups.map((group) => {
          const visibleItems = group.items.filter((item) => hasAccess(item));
          if (visibleItems.length === 0) return null;

          const isExpanded = expandedGroups.includes(group.id);
          const GroupIcon = group.icon;

          return (
            <div key={group.id} className="mb-2">
              <button
                onClick={() => toggleGroup(group.id)}
                className="w-full flex items-center justify-between px-4 py-3 rounded-2xl hover:bg-white/5 transition-all group"
              >
                <div className="flex items-center gap-3">
                  <GroupIcon
                    size={18}
                    className="text-slate-500 group-hover:text-blue-400 transition-colors"
                  />
                  <span className="text-[10px] font-black uppercase tracking-widest text-slate-400 group-hover:text-white italic">
                    {group.label}
                  </span>
                </div>
                <ChevronDown
                  size={14}
                  className={`text-slate-600 transition-transform duration-300 ${isExpanded ? "rotate-180" : ""}`}
                />
              </button>

              <div
                className={`overflow-hidden transition-all duration-500 ${isExpanded ? "max-h-screen opacity-100 mt-2" : "max-h-0 opacity-0"}`}
              >
                <div className="pl-6 space-y-1 border-l border-white/5 ml-6">
                  {visibleItems.map((item, idx) => {
                    const active = pathname === item.path;
                    return (
                      <Link
                        key={`${group.id}-${idx}`}
                        href={item.path}
                        className={`flex items-center justify-between px-4 py-3 rounded-xl transition-all duration-300 ${
                          active
                            ? "bg-blue-600 text-white shadow-lg shadow-blue-900/40 translate-x-1"
                            : "text-slate-500 hover:text-white hover:translate-x-1"
                        }`}
                      >
                        <div className="flex items-center gap-3">
                          <item.icon
                            size={14}
                            className={active ? "text-white" : "opacity-40"}
                          />
                          <span className="text-[10px] font-black uppercase italic tracking-tight">
                            {item.title}
                          </span>
                        </div>
                        {item.badge && (
                          <span className="bg-red-500 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full animate-pulse">
                            {item.badge}
                          </span>
                        )}
                      </Link>
                    );
                  })}
                </div>
              </div>
            </div>
          );
        })}
      </nav>

      {/* PROFILE SECTION */}
      <div className="p-6 border-t border-white/5 bg-[#0B1222]">
        <div className="flex items-center justify-between p-3 rounded-2xl bg-white/5 border border-white/10 group hover:border-blue-500/30 transition-all">
          <div className="flex items-center gap-3 overflow-hidden">
            <div
              className={`w-9 h-9 rounded-xl flex items-center justify-center text-[11px] font-black text-white shrink-0 shadow-lg ${isSuperAdmin ? "bg-amber-500" : "bg-blue-600"}`}
            >
              {user?.U_FirstName?.[0]}
              {user?.U_LastName?.[0]}
            </div>
            <div className="overflow-hidden">
              <p className="text-[10px] font-black uppercase text-slate-100 truncate italic leading-none">
                {user?.U_FirstName}
              </p>
              <p
                className={`text-[7px] font-black uppercase mt-1 tracking-widest ${isSuperAdmin ? "text-amber-500" : "text-blue-500"}`}
              >
                {user?.U_Role}
              </p>
            </div>
          </div>
          <button
            onClick={handleLogout}
            className="p-2 text-slate-600 hover:text-red-500 hover:bg-red-500/10 rounded-lg transition-all"
          >
            <LogOut size={16} />
          </button>
        </div>
      </div>
    </aside>
  );
}
